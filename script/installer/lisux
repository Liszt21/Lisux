#!/usr/bin/env bash

# TODO: add wsl support
# TODO: support debug mode
# TODO: finish basic installition
LISUX=${LISUX:-~/.lisux}

function command_exists() {
	command -v "$@" >/dev/null 2>&1
}

function in_file() {
    grep "$1" < "$2" >/dev/null 2>&1
}

function 4pacman() {
    in_file "archlinuxcn" /etc/pacman.conf || {
        echo "  - add archlinuxcn server"
        printf "[archlinuxcn]\nServer = https://mirrors.163.com/archlinux-cn/\$arch" | sudo tee -a /etc/pacman.conf
        sudo pacman -Sy
        sudo pacman -S archlinuxcn-keyring --noconfirm
    }

    sudo pacman -S yay git vim emacs curl wget zsh base-devel python-pip neofetch --needed
}

function 4yum() {
    sudo yum install git vim emacs curl wget zsh python-pip neofetch
}

function 4apt() {
    sudo apt-get install git vim emacs curl wget zsh python-pip neofetch
}

function y-or-n-p() {
    # $1 message
    # $2 default
    prompt="[Y/n]"
    $2 || {
        prompt="[y/N]"
    }
    $DEBUG && {
        echo "In function y-or-n-p(1: $1, 2: $2, prompt $prompt)"
    }
    if read -r -n1 -t 9 -p "$1 $prompt?" answer;then
        case $answer in
        Y | y)
            return 0;;
        N | n)
            return 1;;
        *)
            echo "Wrong answer: $answer, return default: %2"
            $2 && {
                return 0
            }
            return 1;;
        esac
    else
        echo "Timeout, return default: $2"
        $2 && {
            return 0
        }
        return 1
    fi
}

function install() {
    DISTROBUTION_NAME=$(grep < /etc/os-release -e "^NAME=*" | cut -f 2 -d "\"")
    echo "Hello $USER, Lisux is running in $DISTROBUTION_NAME"

    command_exists yum && 4yum
    command_exists pacman && 4pacman
    command_exists apt && 4apt

    [ "$WSL_DISTRO_NAME" ] && {
        echo "In wsl"
        [ "$USER" = "liszt" ] && [ ! -e "/mnt/c/Liszt/Projects/Lisux" ] && {
            echo "Is me"
            ln -s /mnt/c/Liszt/Projects/Lisux ~/.lisux
        }
    }

    if [ -e "$LISUX" ];then
        echo "Lisux is already installed..."
    else
        git clone https://github.com/Liszt21/Lisux "$LISUX"
        find "$LISUX/bin" -type f -exec chmod o+x {} \;
        find "$LISUX/script" -type f ! -name "*.*" -exec chmod o+x {} \;
    fi

    # Setting environment
    RC_FILE="$HOME/.bashrc"
    [ -f ~/.zshrc ] && {
        RC_FILE="$HOME/.zshrc"
    }

    in_file "lisux/init" "$RC_FILE" || {
        echo "  - push init file to $RC_FILE"
        echo "source $LISUX/init" >> "$RC_FILE"
    }
}

function uninstall() {
    echo "Uninstall lisux"
    # TODO finish uninstall
}

if [ "$DEBUG" ];then
    echo "Debug mode"
    echo "$@"
    if y-or-n-p "test";then
        echo "typed y"
    else
        echo "typed n"
    fi
elif [ "$1" == "uninstall" ];then
    uninstall
else
    install
    source "$LISUX/init"
fi
